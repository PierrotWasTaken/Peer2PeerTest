<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Group Messenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .hidden { display: none; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .peer-tag { font-family: monospace; font-size: 0.7rem; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen font-sans">

    <div class="max-w-4xl mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 border-b border-slate-800 pb-6">
            <div>
                <h1 class="text-3xl font-bold flex items-center gap-2">
                    <i class="fas fa-layer-group text-blue-400"></i> P2P Group Chat
                </h1>
                <div class="flex items-center gap-2 mt-1">
                    <span id="my-id-display" class="text-xs bg-blue-500/20 text-blue-300 px-2 py-0.5 rounded border border-blue-500/30 font-mono">Identifying...</span>
                    <span class="text-slate-500 text-xs">• Serverless • Peer-to-Peer</span>
                </div>
            </div>
            <div id="connection-count" class="px-4 py-1 rounded-full text-xs font-medium border bg-slate-900 border-slate-700 text-slate-400 flex items-center gap-2">
                <i class="fas fa-users"></i> Connected: <span id="peer-count">0</span>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Panel: Connection Tools -->
            <div class="space-y-4">
                <div class="bg-slate-900 border border-slate-800 p-5 rounded-2xl shadow-xl">
                    <h3 class="text-sm font-bold mb-4 uppercase tracking-wider text-slate-400">Invite Someone</h3>
                    <p class="text-xs text-slate-500 mb-3">Generate a code and send it to a friend.</p>
                    <button onclick="createOffer()" id="gen-btn" class="w-full bg-blue-600 hover:bg-blue-500 py-2.5 rounded-xl font-bold transition-all text-sm mb-3">
                        Generate Invite Code
                    </button>
                    
                    <div id="offer-display" class="hidden space-y-2">
                        <div id="offer-box" class="bg-black p-3 rounded-lg text-[10px] font-mono h-24 border border-slate-700 overflow-y-auto break-all text-blue-300 select-all"></div>
                        <button onclick="copyText('offer-box')" class="w-full bg-slate-800 hover:bg-slate-700 py-2 rounded-lg text-xs flex items-center justify-center gap-2">
                            <i class="fas fa-copy"></i> Copy Invite
                        </button>
                    </div>
                </div>

                <div class="bg-slate-900 border border-slate-800 p-5 rounded-2xl shadow-xl">
                    <h3 class="text-sm font-bold mb-4 uppercase tracking-wider text-slate-400">Join a Friend</h3>
                    <textarea id="remote-input" placeholder="Paste invite or response code here..." class="bg-black p-3 rounded-lg text-xs font-mono w-full h-24 border border-slate-700 focus:border-blue-500 focus:outline-none text-purple-300 mb-3"></textarea>
                    <button onclick="handleRemoteCode()" class="w-full bg-purple-600 hover:bg-purple-500 py-2.5 rounded-xl font-bold transition-all text-sm">
                        Connect / Respond
                    </button>
                </div>

                <div id="response-area" class="hidden bg-slate-900 border border-purple-500/50 p-5 rounded-2xl shadow-xl animate-pulse">
                    <h3 class="text-sm font-bold mb-2 text-purple-400">Send Response Back!</h3>
                    <p class="text-[10px] text-slate-400 mb-3">Your friend needs this code to finish the link:</p>
                    <div id="response-box" class="bg-black p-3 rounded-lg text-[10px] font-mono h-24 border border-slate-700 overflow-y-auto break-all text-purple-300 select-all mb-2"></div>
                    <button onclick="copyText('response-box')" class="w-full bg-slate-800 hover:bg-slate-700 py-2 rounded-lg text-xs flex items-center justify-center gap-2">
                        <i class="fas fa-copy"></i> Copy Response
                    </button>
                </div>
            </div>

            <!-- Right Panel: Chat -->
            <div class="lg:col-span-2 flex flex-col bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden min-h-[500px] shadow-2xl">
                <div id="message-list" class="flex-1 p-6 space-y-4 overflow-y-auto h-[400px]">
                    <div class="h-full flex flex-col items-center justify-center text-slate-500 py-12 text-center">
                        <div class="w-16 h-16 bg-blue-500/10 rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-comments text-blue-500 text-2xl"></i>
                        </div>
                        <p class="font-medium text-slate-300">No messages yet</p>
                        <p class="text-xs text-slate-500 max-w-[200px] mt-2">Connect with a friend using the tools on the left to start chatting.</p>
                    </div>
                </div>

                <div class="p-4 bg-slate-800/30 border-t border-slate-800">
                    <div class="flex gap-2">
                        <input id="chat-input" type="text" placeholder="Type a message to the group..." class="flex-1 bg-slate-950 border border-slate-700 rounded-xl px-4 py-2 focus:outline-none focus:border-blue-500 text-sm text-white">
                        <button onclick="sendGroupMessage()" class="bg-blue-600 hover:bg-blue-500 px-6 rounded-xl font-bold transition-all text-sm text-white flex items-center gap-2">
                            <span>Send</span>
                            <i class="fas fa-paper-plane text-[10px]"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const myId = "Peer-" + Math.floor(Math.random() * 9000 + 1000);
        document.getElementById('my-id-display').innerText = "Me: " + myId;

        const connections = {}; // Stores { peerId: { pc, dc } }
        let pendingPC = null; // Temporary PC for the current handshake

        const iceConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }] };

        // --- ENCODING ---
        function encodeSDP(data) {
            const compact = JSON.stringify(data).replace(/v=0\\r\\n/g, 'v0|').replace(/a=candidate:/g, 'ac:').replace(/a=fingerprint:sha-256 /g, 'fp:').replace(/\\r\\n/g, '~');
            return btoa(unescape(encodeURIComponent(compact)));
        }

        function decodeSDP(encoded) {
            const compact = decodeURIComponent(escape(atob(encoded)));
            const jsonString = compact.replace(/v0\|/g, 'v=0\\r\\n').replace(/ac:/g, 'a=candidate:').replace(/fp:/g, 'a=fingerprint:sha-256 ').replace(/~/g, '\\r\\n');
            return JSON.parse(jsonString);
        }

        // --- CONNECTION LOGIC ---
        function createPC(peerId = null) {
            const pc = new RTCPeerConnection(iceConfig);
            pc.oniceconnectionstatechange = () => {
                if (pc.iceConnectionState === 'connected') {
                    document.getElementById('response-area').classList.add('hidden');
                    updatePeerCount();
                }
                if (pc.iceConnectionState === 'disconnected' || pc.iceConnectionState === 'failed') {
                    if (peerId) delete connections[peerId];
                    updatePeerCount();
                }
            };
            return pc;
        }

        function setupDC(dc, peerId) {
            dc.onopen = () => {
                // Identify ourself to the new peer
                dc.send(JSON.stringify({ type: 'identity', id: myId }));
                updatePeerCount();
            };
            dc.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.type === 'identity') {
                    connections[data.id] = { pc: dc.pc, dc: dc };
                    addSystemMessage(`${data.id} joined the chat.`);
                    updatePeerCount();
                } else if (data.type === 'chat') {
                    addChatMessage(data.sender, data.text);
                }
            };
        }

        // Action: Generate Invite
        async function createOffer() {
            const pc = createPC();
            pendingPC = pc;
            const dc = pc.createDataChannel('chat');
            dc.pc = pc; // attach reference
            setupDC(dc);

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            document.getElementById('gen-btn').innerText = "Gathering...";
            
            pc.onicecandidate = (e) => {
                if (!e.candidate) {
                    document.getElementById('offer-box').innerText = encodeSDP(pc.localDescription);
                    document.getElementById('offer-display').classList.remove('hidden');
                    document.getElementById('gen-btn').innerText = "Generate Another Invite";
                }
            };
        }

        // Action: Handle Pasted Code
        async function handleRemoteCode() {
            const code = document.getElementById('remote-input').value.trim();
            if (!code) return;
            const sdp = decodeSDP(code);

            if (sdp.type === 'offer') {
                // We are responding to an invite
                const pc = createPC();
                pendingPC = pc;
                pc.ondatachannel = (e) => {
                    e.channel.pc = pc;
                    setupDC(e.channel);
                };

                await pc.setRemoteDescription(new RTCSessionDescription(sdp));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);

                pc.onicecandidate = (e) => {
                    if (!e.candidate) {
                        document.getElementById('response-box').innerText = encodeSDP(pc.localDescription);
                        document.getElementById('response-area').classList.remove('hidden');
                        document.getElementById('remote-input').value = '';
                    }
                };
            } else if (sdp.type === 'answer') {
                // We are finalizing an invite we sent
                if (!pendingPC) return alert("No pending connection to answer.");
                await pendingPC.setRemoteDescription(new RTCSessionDescription(sdp));
                document.getElementById('offer-display').classList.add('hidden');
                document.getElementById('remote-input').value = '';
                pendingPC = null;
            }
        }

        // --- UI HELPERS ---
        function updatePeerCount() {
            const count = Object.keys(connections).length;
            document.getElementById('peer-count').innerText = count;
        }

        function addChatMessage(sender, text) {
            const list = document.getElementById('message-list');
            if (list.querySelector('.text-center')) list.innerHTML = '';

            const isMe = sender === myId;
            const div = document.createElement('div');
            div.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;
            div.innerHTML = `
                <div class="max-w-[85%]">
                    ${!isMe ? `<div class="peer-tag text-slate-500 mb-1 ml-2">${sender}</div>` : ''}
                    <div class="rounded-2xl px-4 py-2 ${isMe ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-slate-800 text-slate-100 rounded-tl-none border border-slate-700'}">
                        <p class="text-sm">${text}</p>
                    </div>
                </div>
            `;
            list.appendChild(div);
            list.scrollTop = list.scrollHeight;
        }

        function addSystemMessage(text) {
            const list = document.getElementById('message-list');
            const div = document.createElement('div');
            div.className = "flex justify-center my-2";
            div.innerHTML = `<span class="text-[10px] bg-slate-800 text-slate-400 px-3 py-1 rounded-full border border-slate-700">${text}</span>`;
            list.appendChild(div);
            list.scrollTop = list.scrollHeight;
        }

        function sendGroupMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            const packet = JSON.stringify({ type: 'chat', sender: myId, text: msg });
            
            let sentCount = 0;
            Object.values(connections).forEach(peer => {
                if (peer.dc.readyState === 'open') {
                    peer.dc.send(packet);
                    sentCount++;
                }
            });

            addChatMessage(myId, msg);
            input.value = '';
            
            if (sentCount === 0) {
                addSystemMessage("Message not sent. No one is connected yet!");
            }
        }

        function copyText(id) {
            const text = document.getElementById(id).innerText;
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            
            const btn = event.currentTarget;
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check text-green-400"></i> Copied!';
            setTimeout(() => btn.innerHTML = original, 2000);
        }

        document.getElementById('chat-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendGroupMessage(); });
    </script>
</body>
</html>
